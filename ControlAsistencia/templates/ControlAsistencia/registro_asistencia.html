<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Registro de Asistencia</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <h1>Registro de Asistencia</h1>
    <h2 id="reloj">--:--:--</h2>
    <form id="formRegistro" action="" method="post">
        <label for="codigo">Código del Empleado:</label>
        <input type="text" id="codigo" name="codigo" autofocus onkeypress="handleKeyPress(event)">
        <button type="button" onclick="consultarEmpleado()">Ingresar</button>
    </form>
    <div id="listaEmpleados"></div>

    <script>
        function consultarEmpleado() {
            var codigo = $('#codigo').val();
            var ahora = new Date();
            var horas = ahora.getHours();
            var minutos = ahora.getMinutes();
            var segundos = ahora.getSeconds();
            horas = (horas < 10 ? "0" : "") + horas;
            minutos = (minutos < 10 ? "0" : "") + minutos;
            segundos = (segundos < 10 ? "0" : "") + segundos;
            var horaCliente = horas + ':' + minutos + ':' + segundos;

            $.ajax({
                url: '',  // La URL actual maneja la solicitud
                type: 'post',
                data: {
                    'codigo': codigo,
                    'hora_cliente': horaCliente,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.mensaje.includes('Error')) {
                        var errorRegistro = '<p>' + response.mensaje + '</p>';
                        $('#listaEmpleados').prepend(errorRegistro);
                    } else {
                        var registro = '<p>' + response.nombre + ' - ' + response.hora + '</p>';
                        $('#listaEmpleados').prepend(registro);  // Añade al inicio de la lista
                    }
                    mantenerListaCorta();
                    $('#codigo').val('');
                },
                error: function() {
                    $('#listaEmpleados').prepend('<p>Error: Empleado no encontrado.</p>');
                    mantenerListaCorta();
                }
            });
            $('#codigo').val('');  // Limpia el campo después del envío
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                e.preventDefault();  // Evita cualquier comportamiento predeterminado del Enter
                consultarEmpleado();  // Llama a la función que envía la solicitud
            }
        }

        function mantenerListaCorta() {
            var maxItems = 10;
            var items = $('#listaEmpleados p');
            if (items.length > maxItems) {
                items.slice(maxItems).remove();
            }
        }

        function actualizarReloj() {
            var ahora = new Date();
            var horas = ahora.getHours();
            var minutos = ahora.getMinutes();
            var segundos = ahora.getSeconds();
            horas = (horas < 10 ? "0" : "") + horas;
            minutos = (minutos < 10 ? "0" : "") + minutos;
            segundos = (segundos < 10 ? "0" : "") + segundos;
            var strTiempo = horas + ':' + minutos + ':' + segundos;
            document.getElementById("reloj").innerHTML = strTiempo;
        }

        setInterval(actualizarReloj, 1000);
    </script>
</body>
</html>
